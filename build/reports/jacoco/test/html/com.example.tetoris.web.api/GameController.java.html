<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tetoris-game</a> &gt; <a href="index.source.html" class="el_package">com.example.tetoris.web.api</a> &gt; <span class="el_source">GameController.java</span></div><h1>GameController.java</h1><pre class="source lang-java linenums">package com.example.tetoris.web.api;

import com.example.tetoris.application.GameSessionService;
import com.example.tetoris.domain.model.GameState;
import com.example.tetoris.domain.value.Position;
import com.example.tetoris.web.api.dto.GameStateDto;
import com.example.tetoris.web.api.dto.InputRequest;
import com.example.tetoris.web.api.dto.StartGameRequest;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping(&quot;/api/game&quot;)
<span class="nc" id="L28">public class GameController {</span>
<span class="nc" id="L29">  private final GameSessionService service = new GameSessionService();</span>

  @PostMapping(&quot;/start&quot;)
  public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; start(
      @RequestHeader(value = &quot;Idempotency-Key&quot;, required = false) String idemKey,
      @RequestBody(required = false) StartGameRequest req) {
<span class="nc" id="L35">    String id = service.startGameIdempotent(</span>
<span class="nc" id="L36">        Optional.ofNullable(req).map(StartGameRequest::boardWidth),</span>
<span class="nc" id="L37">        Optional.ofNullable(req).map(StartGameRequest::boardHeight),</span>
<span class="nc" id="L38">        Optional.ofNullable(idemKey));</span>
<span class="nc" id="L39">    var session = service.get(id);</span>
<span class="nc" id="L40">    return ResponseEntity.status(HttpStatus.CREATED)</span>
<span class="nc" id="L41">        .header(HttpHeaders.ETAG, String.valueOf(session.rev()))</span>
<span class="nc" id="L42">        .body(Map.of(&quot;id&quot;, id, &quot;state&quot;, toDto(session.rev(), session.state())));</span>
  }

  @PostMapping(&quot;/{id}/input&quot;)
  public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; input(
      @PathVariable String id,
      @RequestHeader(value = &quot;If-Match&quot;, required = false) String ifMatch,
      @RequestHeader(value = &quot;Idempotency-Key&quot;, required = false) String idemKey,
      @RequestBody InputRequest req) {
<span class="nc" id="L51">    var current = service.get(id);</span>
<span class="nc bnc" id="L52" title="All 4 branches missed.">    if (ifMatch != null &amp;&amp; !matchesRev(ifMatch, current.rev())) {</span>
<span class="nc" id="L53">      throw new ConflictException(&quot;rev mismatch: expected If-Match=&quot; + current.rev());</span>
    }
    var session =
<span class="nc bnc" id="L56" title="All 2 branches missed.">        (idemKey != null)</span>
<span class="nc" id="L57">            ? service.applyIdempotent(</span>
<span class="nc" id="L58">                id, idemKey, req.action(), Optional.ofNullable(req.repeat()).orElse(1))</span>
<span class="nc" id="L59">            : service.apply(id, req.action(), Optional.ofNullable(req.repeat()).orElse(1));</span>
<span class="nc" id="L60">    return ResponseEntity.ok()</span>
<span class="nc" id="L61">        .header(HttpHeaders.ETAG, String.valueOf(session.rev()))</span>
<span class="nc" id="L62">        .body(Map.of(&quot;state&quot;, toDto(session.rev(), session.state())));</span>
  }

  @GetMapping(&quot;/{id}/state&quot;)
  public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; state(@PathVariable String id) {
<span class="nc" id="L67">    var session = service.get(id);</span>
<span class="nc" id="L68">    return ResponseEntity.ok()</span>
<span class="nc" id="L69">        .header(HttpHeaders.ETAG, String.valueOf(session.rev()))</span>
<span class="nc" id="L70">        .body(Map.of(&quot;state&quot;, toDto(session.rev(), session.state())));</span>
  }

  @DeleteMapping(&quot;/{id}&quot;)
  public ResponseEntity&lt;Void&gt; delete(@PathVariable String id) {
<span class="nc" id="L75">    service.delete(id);</span>
<span class="nc" id="L76">    return ResponseEntity.noContent().build();</span>
  }

  @ExceptionHandler(GameSessionService.NotFoundException.class)
  public ResponseEntity&lt;ApiError&gt; notFound(GameSessionService.NotFoundException e) {
<span class="nc" id="L81">    return ResponseEntity.status(HttpStatus.NOT_FOUND)</span>
<span class="nc" id="L82">        .body(new ApiError(&quot;GAME_NOT_FOUND&quot;, e.getMessage()));</span>
  }

  @ExceptionHandler(ConflictException.class)
  public ResponseEntity&lt;ApiError&gt; conflict(ConflictException e) {
<span class="nc" id="L87">    return ResponseEntity.status(HttpStatus.CONFLICT)</span>
<span class="nc" id="L88">        .body(new ApiError(&quot;CONFLICT&quot;, e.getMessage()));</span>
  }

  @ExceptionHandler(IllegalArgumentException.class)
  public ResponseEntity&lt;ApiError&gt; badRequest(IllegalArgumentException e) {
<span class="nc" id="L93">    return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="nc" id="L94">        .body(new ApiError(&quot;INVALID_REQUEST&quot;, e.getMessage()));</span>
  }

  private static GameStateDto toDto(int rev, GameState s) {
    // board: 固定ブロックの0/1表現
<span class="nc" id="L99">    List&lt;List&lt;Integer&gt;&gt; board = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">    for (var row : s.board().occupancy()) {</span>
<span class="nc" id="L101">      List&lt;Integer&gt; r = new ArrayList&lt;&gt;(row.size());</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">      for (Boolean b : row) r.add(Boolean.TRUE.equals(b) ? 1 : 0);</span>
<span class="nc" id="L103">      board.add(r);</span>
<span class="nc" id="L104">    }</span>
    // current
<span class="nc" id="L106">    List&lt;GameStateDto.Pos&gt; cells = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">    for (Position p : s.current().cells()) {</span>
<span class="nc" id="L108">      cells.add(new GameStateDto.Pos(p.x(), p.y()));</span>
<span class="nc" id="L109">    }</span>
<span class="nc" id="L110">    var cp = new GameStateDto.CurrentPiece(&quot;O&quot;, cells); // MVP: O固定</span>
<span class="nc" id="L111">    int height = board.size();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">    int width = height == 0 ? 0 : board.get(0).size();</span>
<span class="nc" id="L113">    Map&lt;Integer, String&gt; types = Map.of(0, &quot;EMPTY&quot;, 1, &quot;LOCKED&quot;);</span>
<span class="nc" id="L114">    return new GameStateDto(rev, width, height, board, types, cp, false);</span>
  }

  private static boolean matchesRev(String ifMatch, int rev) {
<span class="nc" id="L118">    String v = ifMatch.trim();</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">    if (v.startsWith(&quot;\&quot;&quot;) &amp;&amp; v.endsWith(&quot;\&quot;&quot;)) {</span>
<span class="nc" id="L120">      v = v.substring(1, v.length() - 1);</span>
    }
<span class="nc" id="L122">    return v.equals(String.valueOf(rev));</span>
  }

<span class="nc" id="L125">  public record ApiError(String code, String message) {}</span>

  public static final class ConflictException extends RuntimeException {
    public ConflictException(String message) {
<span class="nc" id="L129">      super(message);</span>
<span class="nc" id="L130">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>